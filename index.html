<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Christmas PFP Generator</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: Arial, sans-serif;
background: linear-gradient(135deg, #1e3a8a 0%, #7c2d12 100%);
min-height: 100vh;
padding: 20px;
}
.container {
max-width: 600px;
margin: 0 auto;
background: white;
border-radius: 20px;
padding: 30px;
box-shadow: 0 10px 50px rgba(0,0,0,0.3);
}
h1 {
color: #b91c1c;
text-align: center;
margin-bottom: 20px;
font-size: 28px;
}
.profile {
text-align: center;
margin-bottom: 30px;
}
.profile img {
width: 120px;
height: 120px;
border-radius: 50%;
border: 4px solid #15803d;
margin-bottom: 10px;
}
.profile h2 {
color: #15803d;
font-size: 20px;
}
button {
width: 100%;
padding: 18px;
background: linear-gradient(135deg, #b91c1c, #dc2626);
color: white;
border: none;
border-radius: 12px;
font-size: 18px;
font-weight: bold;
cursor: pointer;
margin: 10px 0;
}
button:hover { background: linear-gradient(135deg, #991b1b, #b91c1c); }
button:disabled { opacity: 0.6; cursor: not-allowed; }
.result {
margin-top: 20px;
text-align: center;
}
.result img {
width: 100%;
border-radius: 12px;
margin-top: 15px;
}
.loading {
text-align: center;
color: #15803d;
font-size: 16px;
margin: 20px 0;
}
</style>
</head>
<body>
<div class="container">
<h1>üéÑ Christmas PFP Generator üéÖ</h1>
<div id="app"><p style="text-align:center;color:#666;">Initializing...</p></div>
</div>
<script type="module">
import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';

let userData = null;

async function init() {
    try {
        // Get context from Mini App SDK
        const context = await sdk.context;
        userData = {
            fid: context.user?.fid || 0,
            username: context.user?.username || 'Friend',
            displayName: context.user?.displayName || 'Farcaster User',
            pfpUrl: context.user?.pfpUrl || 'https://via.placeholder.com/150'
        };
        
        // Call ready() to hide splash screen
        await sdk.actions.ready();
        
        renderApp();
    } catch (error) {
        console.error('Init error:', error);
        document.getElementById('app').innerHTML = '<p style="color:red;text-align:center;">'+error.message+'<br><br>Open in Farcaster (Warpcast) to use this app.</p>';
    }
}

function renderApp() {
    const app = document.getElementById('app');
    app.innerHTML = `<div class="profile"><img src="${userData.pfpUrl}" alt="Profile" crossorigin="anonymous" /><h2>Welcome, ${userData.displayName}!</h2></div><button onclick="generateArt()" id="generateBtn">‚ú® Generate Christmas Magic ‚ú®</button><div id="result" class="result"></div>`;
}

async function generateArt() {
    const btn = document.getElementById('generateBtn');
    const resultDiv = document.getElementById('result');
    btn.disabled = true;
    btn.textContent = 'üé® Creating your Christmas magic...';
    resultDiv.innerHTML = '<div class="loading">Generating your unique Christmas portrait...</div>';
    
    try {
        const sweaters = ['festive Nordic pattern sweater', 'reindeer Christmas sweater', 'snowflake knit sweater', 'red and green holiday sweater', 'Fair Isle Christmas sweater'];
        const settings = ['by a frosted window with snow falling outside', 'near a decorated Christmas tree', 'by a warm fireplace', 'in a cozy festive living room'];
        const lights = ['warm golden light', 'twinkling Christmas lights', 'soft candlelight', 'natural winter window light'];
        const extras = ['holding a mug of hot cocoa', 'surrounded by wrapped presents', 'with ornaments in the background', 'with holiday garland visible'];
        
        const sweater = sweaters[Math.floor(Math.random() * sweaters.length)];
        const setting = settings[Math.floor(Math.random() * settings.length)];
        const lighting = lights[Math.floor(Math.random() * lights.length)];
        const extra = extras[Math.floor(Math.random() * extras.length)];
        
        const prompt = `A cozy portrait of ${userData.displayName} on Christmas day, wearing a ${sweater}, smiling warmly, sitting ${setting}, ${extra}, ${lighting}, photorealistic, professional photography, holiday atmosphere`;
        
    const response = await fetch('/api/generate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ prompt: prompt })
    });

                    const prediction = await response.json();
    let result = prediction;
    
    // Poll for result  
    while (result.status === 'starting' || result.status === 'processing') {
      await new Promise(resolve => setTimeout(resolve, 2000));
      const statusResponse = await fetch(result.urls.get);
      result = await statusResponse.json();
    }
    
    if (result.status === 'succeeded' && result.output) {
      const imageUrl = Array.isArray(result.output) ? result.output[0] : result.output;
      resultDiv.innerHTML = `<img src="${imageUrl}" alt="Christmas Art" /><button onclick="window.open('${imageUrl}', '_blank')" style="margin-top:15px; background:#15803d;">‚¨áÔ∏è Download Your Portrait</button><button onclick="generateArt()" style="background:#b91c1c;">üé® Generate Another</button>`;
    }
         else {
               resultDiv.innerHTML = `<p style="color:red;">Error: Generation failed with status ${result.status}</p>`;
              }
 }
        catch (error) {
        console.error('Generation error:', error);
        resultDiv.innerHTML = `<p style="color:red;">Error: ${error.message}<br><br>Details: ${JSON.stringify(error)}</p>`;
    }
    
    btn.disabled = false;
    btn.textContent = '‚ú® Generate Christmas Magic ‚ú®';
}

    // Make generateArt available globally for onclick handler
    window.generateArt = generateArt;

// Initialize when page loads
init();
</script></body>
</html>
